<?xml version="1.0" encoding="UTF-8"?>
<Export generator="Cache" version="25">
<Class name="Fileserver.JSON">
<Super>%Base</Super>
<TimeCreated>63140,78388.642251</TimeCreated>

<Method name="FileListToJSON">
<ClassMethod>1</ClassMethod>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
		set st=$$$OK
		try{
			do ##class(%ZEN.Auxiliary.jsonSQLProvider).%WriteJSONFromSQL(,"SELECT ID, Name, Size, Extension FROM Fileserver.File")
		} catch ex{
			set st=ex.AsStatus()
		}
    	quit st
]]></Implementation>
</Method>

<Method name="RequestFile">
<ClassMethod>1</ClassMethod>
<FormalSpec>FileID:%Integer</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set CheckCustomPermission=1
	if CheckCustomPermission=1 
	{
		set DownloadId=..GenerateDownload(FileID)
		&html<<h2>Your download is ready</h2>>
		w %request.GetCgiEnv("HTTP_HOST")_"/fileserver/download/"_DownloadId
		
	}
	quit $$$OK
]]></Implementation>
</Method>

<Method name="GenerateDownload">
<ClassMethod>1</ClassMethod>
<FormalSpec>FileID:%Integer</FormalSpec>
<ReturnType>%String</ReturnType>
<Implementation><![CDATA[
	set download=##class(Fileserver.Download).%New()
	set download.DateCreated=$ZDATETIME($NOW(),3)
	set download.DateActiveUntil=$ZDATETIME(($PIECE($NOW(),",",1)+1)_","_$PIECE($NOW(),",",2),3)
	set download.IP=%request.GetCgiEnv("REMOTE_ADDR")
	set download.File=##class(Fileserver.File).%OpenId(FileID)
	do download.DownloadIDGenerate()
	set DownloadID = download.DownloadID
	do download.%Save()
	kill download
	quit DownloadID
]]></Implementation>
</Method>

<Method name="DownloadFile">
<ClassMethod>1</ClassMethod>
<FormalSpec>DownloadId:%String</FormalSpec>
<ReturnType>%Status</ReturnType>
<Implementation><![CDATA[
	set FileId=2
	//&SQL(SELECT File INTO :FileId FROM "Download" WHERE DownloadId=:DownloadID)
	set File=##class(Fileserver.File).%OpenId(FileId)
	set %response.ContentType="application/octet-stream"
	do %response.SetHeader("Content-Disposition","attachment; filename="""_File.Name_"""")
	Set stream=##class(%FileBinaryStream).%New()
	Set stream.Filename=File.Directory_File.Name
	While 'stream.AtEnd {
	Set line=stream.Read()
		w line
	}
	
	quit $$$OK
]]></Implementation>
</Method>
</Class>
</Export>
